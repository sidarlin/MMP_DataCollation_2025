---
title: "Merge_datacollation_2025"
output: html_document
date: "2025-03-03"
---

The objectives of this script are to clean and collate shiny app academic camera data submissions with government secure and SPI data sources in one workflow, producing two master files: One master file for species detections rarified to 30 minute independent sampling, and one master file for camera locations across all projects. 

I will first test this data on original submissions, but will incorporate cleaned files up to October 2024 and use this script to clean and merge any new data submissions.

Later steps may include integration of DNA and incidental sighting records and basic mapping scripts for species detections by year.


Link to github account
```{r}
# git config --global user.name "sidarlin"
# git config --global user.email "siobhan.darlington@gov.bc.ca"
# 
# git remote add origin https://github.com/sidarlin/MMP_DataCollation_2025.git

```


1. Load libraries

```{r setup, include=FALSE}
library(terra)
library(ggplot2)
library(sf)
library(readr)
library(farver)
library(ggplot2)
library(rmapshaper)
library(stars)
library(tidyterra)
library(dplyr)
library(rmapshaper)
library(readxl)
library(dplyr)
library(lubridate)

```

2. Collate Camera Trap Projects submitted outside of SPI

Based on Cindy's cleaned data files, the column names for the camera trap effort data should be:
Project_name
Station_ID
Latitude
Longitude
Camera_make
Camera_model
Bait_lure
Camera_comments
Start_Deployment_date
End_Deployment_date
CamProblem_From
CamProblem_to
Habitat_type
Target_feature
Comments

Species column names should be:
Station_ID
Species
Count
Date_Time
Project_name
Counts


```{r}
knitr::opts_knit$set(echo=TRUE, root.dir = "C:/LocalR/Merge_datacollation_2025/Input_project_sheets")
# setwd("C:/LocalR/Merge_datacollation_2025/Input_project_sheets")
getwd()

file.list <- list.files(path = "C:/LocalR/Merge_datacollation_2025/Input_project_sheets", 
                        pattern = "*.xlsx", full.names = TRUE)
master_data <- list()

## Define column mapping (original names â†’ standard names)
column_mapping <- c(
  "Deployment.Location.ID" = "Station_ID",
  "Site" = "Station_ID",
  "site" = "Station_ID",
  "placename" = "Station_ID",
  "location"  = "Station_ID",
  "latitude" = "Latitude",
  "longitude" = "Longitude",
  "Latitude_DD" = "Latitude",
  "Latitude _DD" = "Latitude",
  "Longitude_DD"= "Longitude",
  "UTM_Northing" = "UTM_N",
  "UTM_N" = "UTM_N",
  "UTMN" = "UTM_N",
  "UTME" = "UTM_E",
  "UTM_Easting" = "UTM_E",
  "UTM_E" = "UTM_E",
  "UTM_Zone" = "zone",
  "Zone" = "zone",
  "Camera.Deployment.Begin.Date" = "Start_Deployment_date",
  "Deploy_Date"  = "Start_Deployment_date",
  "start_date" = "Start_Deployment_date",
  "Begin_date" = "Start_Deployment_date",
  "Camera.Deployment.End.Date" = "End_Deployment_date",
  "End_date" = "End_Deployment_date",
  "Retrieval_Date" = "End_Deployment_date",
  "end_date" = "End_Deployment_date",
  "Bait.Type" = "Bait_lure",
  "Feature.Type" = "Target_feature",
  "feature_type" ="Target_feature",
  "Number.of.Animals" = "Count",
  "animal_count" = "Count",
  "Count1" = "Count",
  "total" = "Count", 
  "individual_count" = "Count", 
  "Number" = "Count",
  "sp" = "Species",
  "Species1" = "Species",
  "species_common_name" = "Species",
  "common_name" = "Species",
  "species" = "Species",
  "Date_Time.Captured" = "Date_Time",
  "datetime" = "Date_Time",
  "Datetime" = "Date_Time",
  "image_date_time" = "Date_Time", 
  "dt" = "Date_Time",
  "timestamp" = "Date_Time"
)

## Function to standardize column names
standardize_columns <- function(df) {
  colnames(df) <- recode(colnames(df), !!!column_mapping) # Rename using mapping
  return(df)
}

# Loop through each file
for (i in seq_along(file.list)) {
  file <- file.list[i]
  
  df_cam <- read_excel(file, sheet = 1) %>% standardize_columns()
  df_sp <- read_excel(file, sheet = 2) %>% standardize_columns()
  
  # Extract and clean project name
  project_name <- gsub("^.*data_(.*?)\\-.*$", "\\1", basename(file))
  
 
  # Ensure Station ID is a character
  df_cam$Station_ID <- as.character(df_cam$Station_ID)
  df_sp$Station_ID <- as.character(df_sp$Station_ID)
  
  # Ensure Count is numeric
  df_sp$Count <- as.numeric(df_sp$Count)
  

  # Convert UTM to Latitude/Longitude if UTM columns exist
  if (all(c("UTM_E", "UTM_N", "zone") %in% colnames(df_cam))) {
    df_cam <- df_cam %>%
      filter(!is.na(UTM_E) & !is.na(UTM_N) & !is.na(zone)) %>%
      mutate(zone = as.integer(zone)) %>%
      rowwise() %>%
      mutate(
        geometry = list(st_point(c(UTM_E, UTM_N))),
        crs_utm = 32600 + zone
      ) %>%
      ungroup()
    
    # Convert to sf object
    df_cam_sf <- st_as_sf(df_cam, coords = c("UTM_E", "UTM_N"), crs = unique(df_cam$crs_utm))

    # Transform to WGS84
    df_cam_sf <- st_transform(df_cam_sf, crs = 4326)

    # Extract lat/lon
    df_cam$Longitude <- st_coordinates(df_cam_sf)[, 1]
    df_cam$Latitude <- st_coordinates(df_cam_sf)[, 2]
  }
  
   # Ensure Latitude and Longitude are numeric
  df_cam$Latitude <- as.numeric(df_cam$Latitude)
  df_cam$Longitude <- as.numeric(df_cam$Longitude)
  
  # Standardize deployment data
  deployment_data <- df_cam %>%
    select(any_of(c("Station_ID", "Latitude", "Longitude", "Start_Deployment_date", 
                    "End_Deployment_date", "Camera_make", "Camera_model", "Camera_height", "Bait_lure", "Target_feature"))) %>%
    mutate(across(c(Start_Deployment_date, End_Deployment_date), ~ suppressWarnings(as.Date(.))),
           Project_name = project_name)
  
  # Standardize species data
  species_data <- df_sp %>%
    select(any_of(c("Station_ID", "Species", "Count", "Date_Time"))) %>%
    mutate(Project_name = project_name, # Assign cleaned project name
           Species = gsub("\\.", " ", Species))  # Replace periods with spaces in Species column
  
            # Date_Time = as.POSIXct(Date_Time, tz = "UTC", format = "%Y-%m-%d %H:%M:%S"))

  ## fix Date_Time formatting
if ("Date_Time" %in% colnames(species_data)) {
  species_data <- species_data %>%
    mutate(Date_Time = case_when(
      grepl("AM|PM", Date_Time, ignore.case = TRUE) ~ 
        suppressWarnings(parse_date_time(Date_Time, orders = c("mdy HMS p", "mdy HM p", "ymd HMS p", "ymd HM p"))),
      TRUE ~ suppressWarnings(parse_date_time(Date_Time, orders = c("mdy HMS", "mdy HM", "ymd HMS", "ymd HM")))
    )) %>%
    mutate(Date_Time = as.POSIXct(Date_Time, tz = "UTC", format = "%Y-%m-%d %H:%M:%S"))
} else {
  warning("Column 'Date_Time' not found in species_data.")
}
  

  # Remove unwanted species
species_data <- species_data %>%
  filter(!Species %in% c("Mice, voles, shrews", "Rat", "Cougar", "Bird", "Moose", "Deer", "Martes martes", "Lynx lynx", "Unknown/Indeterminate","-", "NA"))


# Standardize species names to scientific names
species_data$Species_scientific <- recode(species_data$Species,
  # Marten species
  "marten" = "Martes sp.",
  "Marten" = "Martes sp.",
  "American Marten" = "Martes americana",
  "Pacific Marten" = "Martes caurina",

  # Bobcat & Lynx
  "bobcat" = "Lynx rufus",
  "Bobcat" = "Lynx rufus",
  "lynx" = "Lynx canadensis",
  "Lynx" = "Lynx canadensis",
  "Lynx canadiensis" = "Lynx canadensis",
  "Canada lynx" = "Lynx canadensis",
  "Canada Lynx" = "Lynx canadensis",
  "Bobcat/Lynx" = "Lynx sp.",

  # Hare & Rabbit
  "hare" = "Lepus americanus",
  "Snowshoe hare" = "Lepus americanus",
  "Snowshoe Hare" = "Lepus americanus",
  "Rabbits and hares" = "Lepus sp.",

  # Wolverine
  "wolverine" = "Gulo gulo",
  "Wolverine" = "Gulo gulo",

  # Skunk
  "skunk" = "Mephitis mephitis",
  "Skunk" = "Mephitis mephitis",
  "Striped skunk" = "Mephitis mephitis",
  "Striped Skunk" = "Mephitis mephitis",

  # Coyote
  "coyote" = "Canis latrans",
  "Coyote" = "Canis latrans",

  # Weasels
  "weasel" = "Mustela sp.",
  "Mustela sp" = "Mustela sp.",
  "Mustela sp " = "Mustela sp.",
  "Weasels and Ermine" = "Mustela sp.",
  "Long-tailed weasel" = "Neogale frenata",
  "Short-Tailed Weasel" = "Mustela erminea",
  "Ermine" = "Mustela sp.",

  # Fox
  "Red fox" = "Vulpes vulpes",
  "Red Fox" = "Vulpes vulpes",
  "fox" = "Vulpes vulpes",

  # Badger
  "Badger" = "Taxidea taxus",
  "American Badger" = "Taxidea taxus",

  # Fisher
  "Fisher" = "Pekania pennanti",

  # Squirrel
  "Red squirrel" = "Sciurus vulgaris",
  "Red Squirrel" = "Sciurus vulgaris",
  "Red  Squirrel" = "Sciurus vulgaris",
  "Flying Squirrel" = "Glaucomys sabrinus",
  "Squirrel" = "Sciurus sp.",

  # Marmot
  "Marmot" = "Marmota sp.",
  "Hoary Marmot" = "Marmota sp.",

  # Otter
  "Otter" = "Lontra canadensis",
  "River Otter" = "Lontra canadensis",

  # Other species
  "Raccoon" = "Procyon lotor",
  "Porcupine" = "Erethizon dorsatum"
)

# Standardize species names to scientific names
species_data$Species_common_name <- recode(species_data$Species,
  # Marten species
  "marten" = "Marten sp.",
  "Marten" = "Marten sp.",
  "American Marten" = "American marten",
  "Martes americana" = "American marten",
  "Pacific Marten" = "Pacific marten",
  "Martes caurina" = "Pacific marten",
  
  #Wolverine
  "Gulo gulo" = "Wolverine",

  # Bobcat & Lynx
  "bobcat" = "Bobcat",
  "Bobcat" = "Bobcat",
  "lynx" = "Canada lynx",
  "Lynx" = "Canada lynx",
  "Lynx canadiensis" = "Canada lynx",
  "Canada lynx" = "Canada lynx",
  "Canada Lynx" = "Canada lynx",
  "Bobcat/Lynx" = "Lynx sp.",
  "Lynx canadensis" = "Canada lynx",
  "Lynx rufus" = "Bobcat",
  
  #Mink
  "mink" = "American mink", 
  "Neovison vison" = "American mink",
  "Neogale vison" = "American mink",

  # Hare & Rabbit
  "hare" = "Snowshoe hare",
  "Snowshoe hare" = "Snowshoe hare",
  "Snowshoe Hare" = "Snowshoe hare",
  "Rabbits and hares" = "Hare sp.",
  "Lepus americanus" = "Snowshoe hare",

  # Wolverine
  "wolverine" = "Wolverine",
  "Wolverine" = "Wolverine",

  # Skunk
  "skunk" = "Striped skunk",
  "Skunk" = "Striped skunk",
  "Striped skunk" = "Striped skunk",
  "Striped Skunk" = "Striped skunk",
  "Spilogale gracilis" = "Western spotted skunk",
  "Mephitis mephitis" = "Striped skunk",

  # Coyote
  "coyote" = "Coyote",
  "Coyote" = "Coyote",
  "Canis latrans" = "Coyote",

  # Weasels
  "weasel" = "Weasel sp.",
  "Mustela sp" = "Weasel sp.",
  "Mustela sp " = "Weasel sp.",
  "Weasels and Ermine" = "Weasel sp.",
  "Long-tailed weasel" = "Long-tailed weasel",
  "Short-Tailed Weasel" = "Short-tailed weasel",
  "Ermine" = "Weasel sp.",
  "Neogale frenata" = "Long-tailed weasel",
  "Mustela frenata" = "Long-tailed weasel",
  "Mustela nivalis" = "Least weasel",
  "Mustela erminea" = "Eurasian ermine",
  

  # Fox
  "Red fox" = "Red fox",
  "Red Fox" = "Red fox",
  "fox" = "Fox sp.",
  "Vulpes vulpes" = "Red fox",
  "Urocyon cinereoargenteus" = "Gray fox",

  # Badger
  "Badger" = "American badger",
  "American Badger" = "American badger",
  "Taxidea taxus" = "American badger",

  # Fisher
  "Fisher" = "Fisher",
  "Pekania pennanti" = "Fisher",

  # Squirrel
  "Red squirrel" = "Red squirrel",
  "Red Squirrel" = "Red squirrel",
  "Red  Squirrel" = "Red squirrel",
  "Flying Squirrel" = "Flying squirrel",
  "Squirrel" = "Squirrel sp.",
  "Tamiasciurus hudsonicus" = "American red squirrel",

  # Marmot
  "Marmot" = "Marmot sp.",
  "Hoary Marmot" = "Hoary marmot",

  # Otter
  "Otter" = "North American river otter",
  "River Otter" = "North American river otter",
  "Lontra canadensis" = "North American river otter",

  # Other species
  "Raccoon" = "Raccoon",
  "Procyon lotor" = "Raccoon",
  "Porcupine" = "North American porcupine", 
  "Erethizon dorsatum" = "North American porcupine"
)

  # Verify all stations in species and deployments match
  unmatched_stations <- species_data %>% filter(!Station_ID %in% deployment_data$Station_ID)
  
  # Store results
  master_data[[project_name]] <- list(deployment = deployment_data, species = species_data, unmatched = unmatched_stations)
}

# Combine all deployments and species data into master dataframes
master_deployment <- bind_rows(lapply(master_data, "[[", "deployment"))
master_species <- bind_rows(lapply(master_data, "[[", "species"))

``` 


Create a table with project names and deployment years for metadata file
```{r}
# Ensure date columns are in Date format
master_deployment <- master_deployment %>%
  mutate(
    Start_Deployment_date = as.Date(Start_Deployment_date),
    End_Deployment_date = as.Date(End_Deployment_date)
  )

# Summarize start and end years by Project_ID
project_year_summary <- master_deployment %>%
  mutate(
    Start_Year = format(Start_Deployment_date, "%Y"),
    End_Year = format(End_Deployment_date, "%Y")
  ) %>%
  group_by(Project_name) %>%
  summarise(
    Project_Start_Year = min(Start_Year, na.rm = TRUE),
    Project_End_Year = max(End_Year, na.rm = TRUE)
  )

# View the summary
print(project_year_summary)

```



Load the SPI camera data files and standardize to the same formatting as above.


```{r}
library(readxl)
library(dplyr)
library(tidyr)
library(lubridate)

# setwd("C:/LocalR/Merge_datacollation_2025/SPI_cameradata_March2025")
# 
# spi_deploy <- read.csv(file="spi_cam_deploy_March2025.csv", header=T)
#   spi_start <- read.csv(file="spi_cam_start_March2025.csv", header=T)
# 
#   # Join spi_deploy to spi_start by CAMERA_LABEL
# spi_combined <- spi_start %>%
#   left_join(spi_deploy, by = "CAMERA_LABEL", relationship = "many-to-many")
#   
#  write.csv(spi_combined, file="spi_cameras_March2025.csv") 
  
# File paths
file.list <- list.files(path = "C:/LocalR/Merge_datacollation_2025/SPI_cameradata_March2025", 
                        pattern = "*.xlsx", full.names = TRUE)
master_spi_data <- list()  # Initialize storage list

# Column mapping
column_mapping <- c(
  "PROJECT_NAME" = "Project_name",
  "PROJECT_ID" = "SPI_Project_ID",
  "DESIGN_COMPONENT_LABEL" = "Station_ID",
  "CAMERA_LABEL" = "Station_ID",
  "STATION_LATITUDE" = "Latitude",
  "STATION_LONGITUDE" = "Longitude",
  "LATITUDE" = "Latitude",
  "LONGITUDE" = "Longitude",
  "VISIT_START_DATE" = "Start_Deployment_date",
  "VISIT_END_DATE" = "End_Deployment_date",
  "TRAP_MODEL" = "Camera_model",
  "TRAP_MAKE_NAME_CD" = "Camera_make", 
  "BAIT_LURE_TYPE" = "Bait_lure",
  "TRAP_TYPE" = "Target_feature",
  "OBSERVED_NUMBER" = "Count",
  "OBSERVATION_DATETIME" = "Date_Time",
  "TRAP_HEIGHT" = "Camera_height",
  "VISIT_TIME_SPAN" = "Camera_days",
  "SPECIES_ENGLISH_NAME" = "Species_common_name",
  "SCIENTIFIC_NAME" = "Species_scientific" 
)

# Function to standardize column names
standardize_columns <- function(df) {
  colnames(df) <- recode(colnames(df), !!!column_mapping)  
  return(df)
}

# Loop through each file
for (i in seq_along(file.list)) {
  file <- file.list[i]
  
  # Extract project name from filename
  file_name <- gsub("^.*data_(.*?)\\-.*$", "\\1", basename(file))
  
  # Read data and standardize column names
  spi_cam <- read_excel(file, sheet = 1) %>% standardize_columns()
  spi_sp <- read_excel(file, sheet = 2) %>% standardize_columns()
  
  # Standardize deployment data
  deployment_spi_data <- spi_cam %>%
    select(any_of(c("Project_name", "SPI_Project_ID", "Station_ID", "Latitude", "Longitude", "Start_Deployment_date", "End_Deployment_date", "Camera_days", 
                    "Camera_make", "Camera_model", "Camera_height", "Bait_lure", "Target_feature"))) %>%
    mutate(across(c(Start_Deployment_date, End_Deployment_date), ~ suppressWarnings(as.Date(.))))

  # Standardize species data
  species_spi_data <- spi_sp %>%
    select(any_of(c("Project_name", "SPI_Project_ID", "Station_ID","Species_scientific",
                    "Species_common_name" , "Count", "Date_Time"))) %>%
    mutate(Date_Time = parse_date_time(Date_Time, orders = c("ymd HMS", "ymd HM", "ymd H", "ymd")))
  
  # Standardize species names to match the other projects
species_spi_data$Species_common_name <- recode(species_spi_data$Species_common_name,

  "American Marten" = "American marten",
  "White-tailed Deer" = "White-tailed deer",
  "Mule Deer" = "Mule deer",
  "Canada Lynx" = "Canada lynx",
  "Snowshoe Hare" = "Snowshoe hare",
  "Red Fox"  = "Red fox",
  "Red Squirrel" = "Red squirrel",
  "Flying Squirrel" = "Flying squirrel",
  "Short-Tailed Weasel" = "Short-tailed weasel"
  )

  # Verify unmatched stations
  unmatched_spi_stations <- species_spi_data %>% filter(!Station_ID %in% deployment_spi_data$Station_ID)
  
  # Store results
  master_spi_data[[file_name]] <- list(deployment = deployment_spi_data, 
                                       species = species_spi_data, 
                                       unmatched = unmatched_spi_stations)
}

# Combine all deployments and species data into master dataframes
master_spi_deployment <- bind_rows(lapply(master_spi_data, "[[", "deployment"))
master_spi_species <- bind_rows(lapply(master_spi_data, "[[", "species"))

```


Merge camera data from shiny app projects, SPI, FN and other government secure files 

```{r}
## Join all deployments
# Ensure all columns in master_spi_deployment are present in master_deployment
missing_cols <- setdiff(names(master_spi_deployment), names(master_deployment))
master_deployment[missing_cols] <- NA

# Bind rows, keeping all columns from master_spi_deployment
all_cam_deployments <- bind_rows(master_spi_deployment, master_deployment)

#Join all species detections
# Ensure all columns in master_spi_deployment are present in master_deployment
missing_cols <- setdiff(names(master_spi_species), names(master_species))
master_species[missing_cols] <- NA

# Bind rows, keeping all columns from master_spi_species
all_species_cams <- bind_rows(master_spi_species, master_species)

# View result
head(all_species_cams)

## Save a copy to date:
setwd("C:/LocalR/Merge_datacollation_2025/Master_camera_data") 
write.csv(all_cam_deployments, file="All_cam_deployments_March2025.csv")
write.csv(all_species_cams, file="All_camsp_detections_March2025.csv")


### Add lat and long to all_species_cams
all_species_cams <- all_species_cams %>%
  left_join(
    all_cam_deployments %>%
      select(Station_ID, Latitude, Longitude) %>%
      distinct(Station_ID, .keep_all = TRUE),  # Keep unique Station_ID-Latitude-Longitude
    by = "Station_ID"
  )
```


Rarify all camera species detections to 30 min independent events
```{r}
# Ensure Date_Time is in POSIXct format
all_species_cams <- all_species_cams %>%
  mutate(Date_Time = as.POSIXct(Date_Time, format="%Y-%m-%d %H:%M:%S", tz="UTC"),
         Date = as.Date(Date_Time))  # Extract the date for grouping

# Filter for independent detections (30-minute interval per date)
master_species_filtered <- all_species_cams %>%
  arrange(Species_common_name, Station_ID, Date, Date_Time) %>%  # Arrange by Species, Station, Date, and Time
  group_by(Species_common_name, Station_ID, Date) %>%
  filter(is.na(lag(Date_Time)) | (Date_Time - lag(Date_Time)) > minutes(30)) %>%
  ungroup()

# View filtered data
head(master_species_filtered)

table(master_species_filtered$Species_common_name)

```

Join to project metadata file (This is updated in excel as new projects are submitted)
  - Data source (Academic, Government-Not in SPI, First Nations, SPI)
  - Project ID (if in SPI)
  - Contact information: First Name, Last Name, E-mail
  - Project Data Sharing Permissions
  - Comments

Search for projects that contain a species of interest and the contact details for the project

```{r}

setwd("C:/LocalR/Merge_datacollation_2025")
metadata <- read.csv("MMP_Project_Metadata.csv", header=T)

master_species_meta <- master_species_filtered %>%  left_join(metadata, by = "Project_name")

### Filter for a species ###

# Filter for Wolverine records
wolverine_data <- master_species_meta %>%
  filter(Species_common_name == "Wolverine")  # Adjust if name variations exist

# Summarize the number of records per Project_name, including owner details
wolverine_summary <- wolverine_data %>%
  group_by(Species_common_name, Project_name, SPI_Project_ID.x, Data_owner_names, Owner_email) %>%
  summarise(Record_Count = n(), .groups = "drop") %>%
  arrange(desc(Record_Count))  # Sort by highest record count

# View the summary table
print(wolverine_summary)

```


Create a basic interactive map of the camera deployments

```{r}
library(tmap)
library(sf)
library(dplyr)
library(viridis)
library(tmap)

# Convert master_deployment to an sf object, ensuring valid coordinates
camera_stations <- all_cam_deployments %>%
  drop_na(Latitude, Longitude) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)  # WGS84 CRS

# Create a numeric factor for Project_name
camera_stations$Project_ID <- as.numeric(as.factor(camera_stations$Project_name))

# Set tmap mode to interactive
tmap_mode("view")

# Use a continuous color scale instead
tm_basemap("OpenStreetMap") +
  tm_shape(camera_stations) +
  tm_dots(col = "Project_ID", palette = "viridis", 
          size = 0.6, alpha = 0.9, title = "Project (by ID)") +
  tm_layout(title = "Camera Station Locations by Project",
            legend.outside = TRUE)


```

Create a basic interactive map from the camera species detections

```{r}
# Load required libraries
library(ggplot2)
library(ggmap)
library(dplyr)
library(tmap)
library(viridis)

# Ensure Station_ID is the same type in both dataframes
master_species_join <- master_species_meta %>%
  left_join(
    all_cam_deployments %>%
      select(Station_ID, Latitude, Longitude) %>%
      distinct(Station_ID, .keep_all = TRUE),  # Keep unique Station_ID-Latitude-Longitude
    by = "Station_ID"
  )

# Filter for Pekania pennanti and remove NA coordinates
species_map_data <- master_species_join %>%
  filter(Species_common_name == "Wolverine") %>% #Pekania pennanti
  drop_na(Latitude, Longitude) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)  # Convert to sf spatial object

# Interactive map with OpenStreetMap
tmap_mode("view")  # Use "plot" instead for a static map
tm_basemap("OpenStreetMap") +
  tm_shape(species_map_data) +
  tm_dots(col = "red", size = 0.2) +
  tm_layout(title = "Wolverine Camera Detections in British Columbia")
```

Extract species specific data observations as its own csv file with latitude and longitude associated 

```{r}
# Extract coordinates
species_map_data <- species_map_data %>%
  mutate(Latitude = st_coordinates(.)[, 2],  # Extract Y (Latitude)
         Longitude = st_coordinates(.)[, 1]) %>%  # Extract X (Longitude)
  st_drop_geometry()  # Remove geometry column

# View the new dataframe
head(species_map_data)

## Export
setwd("C:/LocalR/Merge_datacollation_2025/Output_camera_detections")
write.csv(species_map_data, file="Fisher_cam_detections_temp_March2025.csv")

fisher_detection_data <- read.csv("Fisher_cam_detections_temp_March2025.csv")
# Filter for Pekania pennanti and remove NA coordinates
fisher_map_sf <- fisher_detection_data %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)  # Convert to sf spatial object

# Interactive map with OpenStreetMap
tmap_mode("view")  # Use "plot" instead for a static map
tm_basemap("OpenStreetMap") +
  tm_shape(fisher_map_sf) +
  tm_dots(col = "red", size = 0.2) +
  tm_layout(title = "Fisher Camera Detections in British Columbia")
```

#############################################################################

Let's add in the incidental data and the DNA data to the camera species list (with coordinates) and attach the metadata 

Notes:
- The DNA collation R script needs to be redone like the camera data script
  There are a large number of NAs in the BC hydro file for "Start_date" and NULL and NA records for species.
- Incidental data are missing complete dates (many are just years) and some BCTA records have no coordinates attached.

```{r}
## Add the DNA database
setwd("C:/LocalR/Merge_datacollation_2025/DNA_records")

DNA_data <- read.csv(file="DNA_presence_only_03-06.csv", header=T)

# Standardize species names to scientific names
DNA_data$Species_scientific <- recode(DNA_data$Species,
"Lynx Canadensis" = "Lynx canadensis",
"M-PEPE" = "Pekania pennanti",
"M-PRLO" = "Procyon lotor",
"M-MEME" = "Mephitis mephitis", 
"M-SPGR" = "Spilogale gracilis",
"M-GUGU" = "Gulo gulo",
"M-MAAM" = "Martes americana",
"M-MACU" = "Martes caurina",
"M-MUER-HA" = "Mustela haidarum",
"M-MUER" = "Mustela erminea",
"M-MUER-AN" = "Mustela erminea",
"M-MUNI" = "Mustela nivalis",
"M-MUFR" = "Neogale frenata",
"M-NEVI" = "Neovison vison",
"M-TATA" = "Taxidea taxus",
"M-LYRU" = "Lynx rufus",
"M-LYCA" = "Lynx canadiensis",
"M-CALA"= "Canis latrans",
"M-VUVU" = "Vulpes vulpes",
"M-LOCA" = "Lontra canadensis"
 )

# Standardize species names to scientific names
DNA_data$Species_common_name <- recode(DNA_data$Species,
                                           
 "Lynx Canadensis" = "Canada lynx",
"M-PEPE" = "Fisher",
"M-PRLO" = "Raccoon",
"M-MEME" = "Striped skunk", 
"M-SPGR" = "Western spotted skunk",
"M-GUGU" = "Wolverine",
"M-MAAM" = "American marten",
"M-MACU" = "Pacific marten",
"M-MUER-HA" = "Haida ermine",
"M-MUER" = "Short-tailed weasel",
"M-MUER-AN" = "Short-tailed weasel",
"M-MUNI" = "Least weasel",
"M-MUFR" = "Long-tailed weasel",
"M-NEVI" = "American mink",
"M-TATA" = "American badger",
"M-LYRU" = "Bobcat",
"M-LYCA" = "Canada lynx",
"M-CALA"= "Coyote",
"M-VUVU" = "Red fox",
"M-LOCA" = "North American river otter",
"FLSQ" = "Flying squirrel",

  "Martes americana" = "American marten",
  "Martes caurina" = "Pacific marten",
  "Gulo gulo" = "Wolverine",
  "Lynx canadiensis" = "Canada lynx",
  "Lynx canadensis" = "Canada lynx",
  "Lynx rufus" = "Bobcat",
  "Neovison vison" = "American mink",
  "Neogale vison" = "American mink",
  "Lepus americanus" = "Snowshoe hare",
  "Striped Skunk" = "Striped skunk",
  "Spilogale gracilis" = "Western spotted skunk",
  "Mephitis mephitis" = "Striped skunk",
  "Canis latrans" = "Coyote",
  "Neogale frenata" = "Long-tailed weasel",
  "Mustela frenata" = "Long-tailed weasel",
  "Mustela nivalis" = "Least weasel",
  "Mustela erminea" = "Eurasian ermine",
  "Vulpes vulpes" = "Red fox",
  "Urocyon cinereoargenteus" = "Gray fox",
  "Taxidea taxus" = "American badger",
  "Pekania pennanti" = "Fisher",
  "Tamiasciurus hudsonicus" = "American red squirrel",
  "Lontra canadensis" = "North American river otter",
  "Procyon lotor" = "Raccoon",
  "Porcupine" = "North American porcupine", 
  "Erethizon dorsatum" = "North American porcupine"
)

table(DNA_data$Species_common_name)

## remove any duplicates


```



Get the project start and end dates
```{r}
DNA_deployment <-DNA_data %>%
  mutate(
    Start_Deployment_date = as.Date(Start_Deployment_date),
    End_Deployment_date = as.Date(End_Deployment_date)
  )

# Summarize start and end years by Project_ID
DNA_project_year_summary <- DNA_deployment %>%
  mutate(
    Start_Year = format(Start_Deployment_date, "%Y"),
    End_Year = format(End_Deployment_date, "%Y")
  ) %>%
  group_by(Project_name) %>%
  summarise(
    Project_Start_Year = min(Start_Year, na.rm = TRUE),
    Project_End_Year = max(End_Year, na.rm = TRUE)
  )

# View the summary
print(DNA_project_year_summary)
```


```{r}

#Join camera data and DNA data
# Ensure all columns in master_spi_deployment are present in master_deployment
missing_cols <- setdiff(names(DNA_data), names(master_species_filtered))
master_species_filtered[missing_cols] <- NA

# Bind rows, keeping all columns from master_spi_species
all_cams_dna_species <- bind_rows(master_species_filtered, DNA_data)


#load metadata if you haven't already
setwd("C:/LocalR/Merge_datacollation_2025")
metadata <- read.csv("MMP_Project_Metadata.csv", header=T)

cams_dna_sp_meta <- all_cams_dna_species %>%  left_join(metadata, by = "Project_name")

write.csv(cams_dna_sp_meta, file="Cam_DNA_species_March2025.csv")

table(cams_dna_sp_meta$Species_common_name)

```

Extract species specific data observations as its own csv file with latitude and longitude associated 

```{r}
# Extract coordinates
species_map_data <- species_map_data %>%
  mutate(Latitude = st_coordinates(.)[, 2],  # Extract Y (Latitude)
         Longitude = st_coordinates(.)[, 1]) %>%  # Extract X (Longitude)
  st_drop_geometry()  # Remove geometry column

# View the new dataframe
head(species_map_data)

## Export
setwd("C:/LocalR/Merge_datacollation_2025/Output_camera_detections")
write.csv(species_map_data, file="Fisher_cam_detections_temp_March2025.csv")
```

Let's map Marten camera detections by data sharing permissions
```{r}
cams_dna_sp_meta <- cams_dna_sp_meta %>%
  mutate(across(everything(), ~ iconv(., from = "", to = "UTF-8", sub = " ")))  # Replace invalid characters
Encoding(cams_dna_sp_meta$Species_common)  # Check encoding
unique(cams_dna_sp_meta$Species_common_name)    # Look for strange characters

write.csv(cams_dna_sp_meta, "cam_dna_temp_data.csv", row.names = FALSE, fileEncoding = "UTF-8")
cams_dna_sp_meta <- read.csv("cam_dna_temp_data.csv", stringsAsFactors = FALSE, encoding = "UTF-8")


# Define custom colors
custom_colors <- c("Martes caurina" = "#00796B",  # Dark Teal
                   "Martes sp." = "#D84315",      # Dark Orange
                   "Martes americana" = "#6F249C")  # Dark Purple

# Define custom shapes
custom_shapes <- c("Level1" = 16,  # Filled circle
                   "Level2" = 17,  # Filled triangle
                   "Level3" = 18)  # Filled diamond

# Filter for Marten species, remove NA coordinates, and select necessary columns
species_map_data <- cams_dna_sp_meta %>%
  filter(Species_scientific %in% c("Martes caurina", "Martes sp.", "Martes americana")) %>%
  drop_na(Latitude, Longitude, Data_Sharing_Categorization) %>%  # Ensure no NAs in shape field
  mutate(
    Year_Study_Start = as.character(Year_Study_Start),  # Convert to character to avoid comma formatting
    Year_Study_End = as.character(Year_Study_End)  # Convert to character to avoid comma formatting
  ) %>%
  select(-c(Species.x, Species.y, Study_Area, Description, Start_Deployment_date, End_Deployment_date, Sex, Age, Habitat_type, Comments, Trap_type, Sample_ID, SPI_Project_ID.y, SPI_Project_name, Animal_ID, 
            Submission_File_link, Submission_File_name, Data_owner_names, 
            Owner_email, Data._Sharing_Notes, Date_Time, Count, Date, Station_ID, Wildtrax_ID, SPI_Project_Name)) %>%  # Remove specified columns
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)  # Convert to sf spatial object


# Rename Species_scientific to Species in the dataset
species_map_data <- species_map_data %>%
  rename(Species = Species_scientific)

# Interactive map with OpenStreetMap
tmap_mode("view")  # Enable interactive view mode

tm_basemap("OpenStreetMap") +
  tm_shape(species_map_data) +
  tm_dots(col = "Species", shape = "Data_Sharing_Categorization", 
          size = 0.6, palette = custom_colors, shape.palette = custom_shapes, 
          title.shape = "Data Permissions") +  # Shape legend title is working
  tm_layout(title = "Marten Camera and DNA Detections in British Columbia",
            legend.outside = TRUE) +  # Move legend outside for better visibility
  tm_view(set.zoom.limits = c(5, 7))  # Adjust zoom limits

```

Make a cam and DNA fisher map
```{r}
cams_dna_sp_meta <- cams_dna_sp_meta %>%
  mutate(across(everything(), ~ iconv(., from = "", to = "UTF-8", sub = " ")))  # Replace invalid characters
Encoding(cams_dna_sp_meta$Species_common)  # Check encoding
unique(cams_dna_sp_meta$Species_common_name)    # Look for strange characters

write.csv(cams_dna_sp_meta, "cam_dna_temp_data.csv", row.names = FALSE, fileEncoding = "UTF-8")
cams_dna_sp_meta <- read.csv("cam_dna_temp_data.csv", stringsAsFactors = FALSE, encoding = "UTF-8")


# Define custom colors
custom_colors <- c("Martes caurina" = "#00796B",  # Dark Teal
                   "Martes sp." = "#D84315",      # Dark Orange
                   "Martes americana" = "#6F249C")  # Dark Purple

# Define custom shapes
custom_shapes <- c("Level1" = 16,  # Filled circle
                   "Level2" = 17,  # Filled triangle
                   "Level3" = 18)  # Filled diamond

# Filter for Marten species, remove NA coordinates, and select necessary columns
species_map_data <- cams_dna_sp_meta %>%
  filter(Species_scientific %in% c("Martes caurina", "Martes sp.", "Martes americana")) %>%
  drop_na(Latitude, Longitude, Data_Sharing_Categorization) %>%  # Ensure no NAs in shape field
  mutate(
    Year_Study_Start = as.character(Year_Study_Start),  # Convert to character to avoid comma formatting
    Year_Study_End = as.character(Year_Study_End)  # Convert to character to avoid comma formatting
  ) %>%
  select(-c(Species.x, Species.y, Study_Area, Description, Start_Deployment_date, End_Deployment_date, Sex, Age, Habitat_type, Comments, Trap_type, Sample_ID, SPI_Project_ID.y, SPI_Project_name, Animal_ID, 
            Submission_File_link, Submission_File_name, Data_owner_names, 
            Owner_email, Data._Sharing_Notes, Date_Time, Count, Date, Station_ID, Wildtrax_ID, SPI_Project_Name)) %>%  # Remove specified columns
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)  # Convert to sf spatial object


# Rename Species_scientific to Species in the dataset
species_map_data <- species_map_data %>%
  rename(Species = Species_scientific)

# Interactive map with OpenStreetMap
tmap_mode("view")  # Enable interactive view mode

tm_basemap("OpenStreetMap") +
  tm_shape(species_map_data) +
  tm_dots(col = "Species", shape = "Data_Sharing_Categorization", 
          size = 0.6, palette = custom_colors, shape.palette = custom_shapes, 
          title.shape = "Data Permissions") +  # Shape legend title is working
  tm_layout(title = "Marten Camera and DNA Detections in British Columbia",
            legend.outside = TRUE) +  # Move legend outside for better visibility
  tm_view(set.zoom.limits = c(5, 7))  # Adjust zoom limits
```


Add incidental data from spi (2023 data with incorrect count until Sultana can get us new extraction)

```{r}
## Add Incidentals
setwd("C:/LocalR/Merge_datacollation_2025/Input_incidental_sheets")

inci_spi_data <- read.csv(file="SPI_Incidentals_Oct2023.csv", header=T)

# Column mapping
column_mapping <- c(
  "PROJECT_NAME" = "SPI_Project_name",
  "PROJECT_ID" = "SPI_Project_ID",
  "DESIGN_COMPONENT_LABEL" = "Station_ID",
  "CAMERA_LABEL" = "Station_ID",
  "STATION_LATITUDE" = "Latitude",
  "STATION_LONGITUDE" = "Longitude",
  "LATITUDE" = "Latitude",
  "LONGITUDE" = "Longitude",
  "VISIT_START_DATE" = "Start_Deployment_date",
  "VISIT_END_DATE" = "End_Deployment_date",
  "TRAP_MODEL" = "Camera_model",
  "TRAP_MAKE_NAME_CD" = "Camera_make", 
  "BAIT_LURE_TYPE" = "Bait_lure",
  "TRAP_TYPE" = "Target_feature",
  "OBSERVED_NUMBER" = "Count",
  "OBSERVATION_YEAR" = "Year",
  "OBSERVATION_DATETIME" = "Date_Time",
  "TRAP_HEIGHT" = "Camera_height",
  "VISIT_TIME_SPAN" = "Camera_days",
  "SPECIES_ENGLISH_NAME" = "Species_common_name",
  "SCIENTIFIC_NAME" = "Species_scientific" 
)

# Function to standardize column names
standardize_columns <- function(df) {
  colnames(df) <- recode(colnames(df), !!!column_mapping)  
  return(df)
}

#Apply to incidental SPI sheet
inci_spi_data <- inci_spi_data %>% standardize_columns()


# Standardize species names to scientific names
inci_spi_data$Species_common_name <- recode(inci_spi_data$Species_common_name,
  # Marten species
  "marten" = "Marten sp.",
  "Marten" = "Marten sp.",
  "American Marten" = "American marten",
  "Martes americana" = "American marten",
  "Pacific Marten" = "Pacific marten",
  "Martes caurina" = "Pacific marten",
  
  # Bobcat & Lynx
  "bobcat" = "Bobcat",
  "lynx" = "Canada lynx",
  "Lynx" = "Canada lynx",
  "Lynx canadiensis" = "Canada lynx",
  "Canada Lynx" = "Canada lynx",
  "Bobcat/Lynx" = "Lynx sp.",

  #Mink
  "American Mink" = "American mink", 

  # Hare & Rabbit
  "Snowshoe hare" = "Snowshoe hare",
  "Snowshoe Hare" = "Snowshoe hare",
  "Rabbits and hares" = "Hare sp.",

  # Wolverine
  "wolverine" = "Wolverine",
  "Wolverine, Luscus Subspecies" = "Wolverine",
  "Wolverine, Vancouverensis Subspecies" = "Wolverine",

  # Skunk
  "Skunk" = "Striped skunk",
  "Striped skunk" = "Striped skunk",
  "Striped Skunk" = "Striped skunk",
  "Western Spotted Skunk" = "Western spotted skunk",
  

  # Coyote
  "coyote" = "Coyote",
  "Coyote" = "Coyote",

  # Weasels
  "weasel" = "Weasel sp.",
  "Mustela sp" = "Weasel sp.",
  "Mustela sp " = "Weasel sp.",
  "Weasels and Ermine" = "Weasel sp.",
  "Long-tailed Weasel" = "Long-tailed weasel",
 "Long-Tailed Weasel" = "Long-tailed weasel",
  "Short-tailed Weasel" = "Short-tailed weasel",
  "Short-Tailed Weasel" = "Short-tailed weasel",
 "Long-tailed weasel, altifrontalis subspecies" = "Long-tailed weasel",
 
  # Fox
  "Gray Fox" = "Gray fox",
  "Red Fox" = "Red fox",
  "fox" = "Fox sp.",

  # Badger
  "American Badger" = "American badger",

  # Fisher
  "Fisher" = "Fisher",

  # Squirrel
 "American Red Squirrel" = "American red squirrel",
  "Red squirrel" = "Red squirrel",
  "Red Squirrel" = "Red squirrel",
  "Red  Squirrel" = "Red squirrel",
  "Flying Squirrel" = "Flying squirrel",
  "Squirrel" = "Squirrel sp.",

  # Marmot
  "Marmot" = "Marmot sp.",
  "Hoary Marmot" = "Hoary marmot",

  # Otter
  "North American River Otter" = "North American river otter",
"North American River Otter pacifica" = "North American river otter",

  # Other species
"Raccoon pacificus" = "Raccoon",
  "North American Porcupine" = "North American porcupine", 
)

inci_spi_data$Data_Sharing_Categorization <- "Government"
inci_spi_data$Data_type <- "Incidental"
```

Attach the Camera/DNA with metadata sheet

```{r}
# cams_dna_sp_meta$SPI_Project_ID <- cams_dna_sp_meta$SPI_Project_ID.x
# 
# # Remove unwanted columns from cams_dna_sp_meta
# cams_dna_sp_meta <- cams_dna_sp_meta %>%
#   select(-c(SPI_Project_ID.x, SPI_Project_ID.y))

# Identify common columns between the two dataframes
common_cols <- intersect(names(inci_spi_data), names(cams_dna_sp_meta))

# Retain only the common columns in inci_spi_data
inci_spi_data <- inci_spi_data[, common_cols, drop = FALSE]

# Bind rows, keeping only the common columns
all_sources_species <- bind_rows(cams_dna_sp_meta, inci_spi_data)

# Remove columns where all characters are uppercase
all_sources_species <- all_sources_species %>%
  select(-which(grepl("^[A-Z_]+$", names(.))))


# Remove unwanted columns from cams_dna_sp_meta
all_sources_species <- all_sources_species %>%
  select(-c(Species.x, Species.y))


# Remove rows where Species_common_name is "Mule deer" or "White-tailed deer"
all_sources_species <- all_sources_species %>%
  filter(!(Species_common_name %in% c("Mule deer", "White-tailed deer")))

write.csv(all_sources_species, file="All_sources_species_March2025.csv")

```

